name: oci-push

on:
  workflow_run:
    workflows: 
    - oci-builds
    types:
      - completed
  
jobs:
  push:
    name: push
    if: |
      github.event.workflow_run.conclusion == 'success' 
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:

    - name: Download mapt assets
      uses: actions/download-artifact@v4
      with:
        name: mapt
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ github.token }}
    
    - name: Get mapt build informaiton
      run: |
        echo "source_event=$(cat mapt-event)" >> "$GITHUB_ENV"
        echo "image=$(cat mapt-image)" >> "$GITHUB_ENV"

    - name: Log in to ghcr.io
      if: ${{ env.source_event == 'pull_request' }}
      uses: redhat-actions/podman-login@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Log in quay.io
      if: ${{ env.source_event == 'push' }}
      uses: redhat-actions/podman-login@v1
      with:
        registry: quay.io
        username: ${{ secrets.QUAY_IO_USERNAME }}
        password: ${{ secrets.QUAY_IO_PASSWORD }}

    - name: Push mapt
      run: |
        # Load images from build
        podman load -i mapt-arm64.tar
        podman load -i mapt-amd64.tar 
        
        # Push
        podman push ${{ env.image }})-arm64
        podman push ${{ env.image }})-amd64
        podman manifest create ${{ env.image }})
        podman manifest add ${{ env.image }}) docker://${{ env.image }})-arm64
        podman manifest add ${{ env.image }}) docker://${{ env.image }})-amd64
        podman manifest push --all ${{ env.image }})
